<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tigray Interactive Map</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin=""/>
    
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
            crossorigin=""></script>

    <!-- Additional Leaflet plugins -->
    <script src="https://unpkg.com/leaflet-kml@1.0.0/L.KML.js"></script>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        
        #map {
            height: 100vh;
            width: 100%;
        }
        
        .map-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .control-group {
            margin-bottom: 10px;
        }
        
        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 14px;
        }
        
        .control-group select,
        .control-group input[type="checkbox"] {
            margin-right: 5px;
        }
        
        .legend {
            position: absolute;
            bottom: 10px;
            left: 10px;
            z-index: 1000;
            background: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 250px;
        }
        
        .legend h4 {
            margin: 0 0 10px 0;
            font-size: 16px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            border: 1px solid #ccc;
        }
        
        .info-panel {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 300px;
            display: none;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1001;
            background: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">
        <div>Loading Tigray Map...</div>
    </div>

    <div class="map-controls">
        <div class="control-group">
            <label>
                <input type="checkbox" id="zones-toggle" checked> Show Administrative Zones
            </label>
        </div>
        <div class="control-group">
            <label>
                <input type="checkbox" id="towns-toggle" checked> Show Major Towns
            </label>
        </div>
        <div class="control-group">
            <label>
                Map Style:
                <select id="basemap-select">
                    <option value="osm">OpenStreetMap</option>
                    <option value="satellite">Satellite</option>
                    <option value="terrain">Terrain</option>
                </select>
            </label>
        </div>
    </div>

    <div class="info-panel" id="info-panel">
        <h4 id="info-title">Click on a feature</h4>
        <div id="info-content">Select a zone or town to see details</div>
    </div>

    <div class="legend">
        <h4>Map Legend</h4>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #3388ff; opacity: 0.6;"></div>
            <span>Administrative Zones</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #ff6b35;"></div>
            <span>Major Towns</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #28a745;"></div>
            <span>Regional Capital</span>
        </div>
    </div>

    <div id="map"></div>

    <script>
        // Initialize the map
        var map = L.map('map').setView([14.2701, 38.2751], 8);

        // Base layers
        var baseLayers = {
            'OpenStreetMap': L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '© OpenStreetMap contributors'
            }),
            'Satellite': L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                maxZoom: 19,
                attribution: 'Tiles © Esri'
            }),
            'Terrain': L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                maxZoom: 17,
                attribution: 'Map data: © OpenStreetMap contributors, SRTM | Map style: © OpenTopoMap'
            })
        };

        // Add default layer
        baseLayers['OpenStreetMap'].addTo(map);

        // Layer groups
        var zonesLayer = L.layerGroup().addTo(map);
        var townsLayer = L.layerGroup().addTo(map);

        // Style functions
        function zoneStyle(feature) {
            return {
                fillColor: '#3388ff',
                weight: 2,
                opacity: 1,
                color: 'white',
                dashArray: '3',
                fillOpacity: 0.6
            };
        }

        function highlightFeature(e) {
            var layer = e.target;
            layer.setStyle({
                weight: 5,
                color: '#666',
                dashArray: '',
                fillOpacity: 0.8
            });
            
            if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
                layer.bringToFront();
            }
            
            updateInfoPanel(layer.feature.properties);
        }

        function resetHighlight(e) {
            zonesGeoJSON.resetStyle(e.target);
            hideInfoPanel();
        }

        function updateInfoPanel(properties) {
            var panel = document.getElementById('info-panel');
            var title = document.getElementById('info-title');
            var content = document.getElementById('info-content');
            
            title.textContent = properties.Name || properties.name || 'Unknown';
            
            var details = [];
            if (properties.Population) details.push(`Population: ${properties.Population.toLocaleString()}`);
            if (properties.Area) details.push(`Area: ${properties.Area} km²`);
            if (properties.Capital) details.push(`Capital: ${properties.Capital}`);
            if (properties.Type) details.push(`Type: ${properties.Type}`);
            
            content.innerHTML = details.length > 0 ? details.join('<br>') : 'No additional information available';
            panel.style.display = 'block';
        }

        function hideInfoPanel() {
            document.getElementById('info-panel').style.display = 'none';
        }

        function onEachZone(feature, layer) {
            layer.on({
                mouseover: highlightFeature,
                mouseout: resetHighlight,
                click: function(e) {
                    map.fitBounds(e.target.getBounds());
                }
            });
        }

        // Load GeoJSON data
        var zonesGeoJSON, townsKML;

        // Try to load zones data
        fetch('./tigray_zones.geojson')
            .then(response => response.json())
            .then(data => {
                zonesGeoJSON = L.geoJSON(data, {
                    style: zoneStyle,
                    onEachFeature: onEachZone
                }).addTo(zonesLayer);
                
                // Fit map to zones bounds
                map.fitBounds(zonesGeoJSON.getBounds());
                hideLoading();
            })
            .catch(error => {
                console.log('Could not load zones data:', error);
                addSampleZones();
                hideLoading();
            });

        // Try to load towns KML
        fetch('./towns.kml')
            .then(response => response.text())
            .then(kmlString => {
                townsKML = new L.KML(kmlString);
                townsKML.addTo(townsLayer);
            })
            .catch(error => {
                console.log('Could not load towns KML:', error);
                addSampleTowns();
            });

        // Add sample data if files are not available
        function addSampleZones() {
            var sampleZones = [
                { name: "Central Tigray", coords: [[14.5, 38.5], [14.5, 39.0], [15.0, 39.0], [15.0, 38.5]] },
                { name: "Eastern Tigray", coords: [[14.5, 39.0], [14.5, 39.5], [15.0, 39.5], [15.0, 39.0]] },
                { name: "Southern Tigray", coords: [[14.0, 38.5], [14.0, 39.0], [14.5, 39.0], [14.5, 38.5]] },
                { name: "Western Tigray", coords: [[14.5, 37.5], [14.5, 38.5], [15.0, 38.5], [15.0, 37.5]] },
                { name: "Northwestern Tigray", coords: [[15.0, 37.5], [15.0, 38.5], [15.5, 38.5], [15.5, 37.5]] },
                { name: "North Tigray", coords: [[15.0, 38.5], [15.0, 39.0], [15.5, 39.0], [15.5, 38.5]] },
                { name: "Southeastern Tigray", coords: [[14.0, 39.0], [14.0, 39.5], [14.5, 39.5], [14.5, 39.0]] }
            ];

            sampleZones.forEach(zone => {
                var polygon = L.polygon(zone.coords, {
                    color: '#3388ff',
                    fillOpacity: 0.6
                }).addTo(zonesLayer);
                
                polygon.bindPopup(`<b>${zone.name}</b><br>Administrative Zone`);
            });
        }

        function addSampleTowns() {
            var sampleTowns = [
                { name: "Mekelle", coords: [13.4967, 39.4753], type: "Regional Capital" },
                { name: "Axum", coords: [14.1211, 38.7236], type: "Historic City" },
                { name: "Adwa", coords: [14.1700, 38.9000], type: "Historic Town" },
                { name: "Shire", coords: [14.1078, 37.9706], type: "Town" },
                { name: "Humera", coords: [14.2970, 36.6330], type: "Town" },
                { name: "Alamata", coords: [12.4167, 39.5333], type: "Town" },
                { name: "Wukro", coords: [13.7833, 39.6000], type: "Town" },
                { name: "Adigrat", coords: [14.2751, 39.4617], type: "Town" }
            ];

            sampleTowns.forEach(town => {
                var color = town.type === "Regional Capital" ? "#28a745" : "#ff6b35";
                var radius = town.type === "Regional Capital" ? 8 : 6;
                
                var marker = L.circleMarker(town.coords, {
                    radius: radius,
                    fillColor: color,
                    color: "#fff",
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(townsLayer);
                
                marker.bindPopup(`<b>${town.name}</b><br>Type: ${town.type}`);
            });
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        // Control event handlers
        document.getElementById('zones-toggle').addEventListener('change', function(e) {
            if (e.target.checked) {
                map.addLayer(zonesLayer);
            } else {
                map.removeLayer(zonesLayer);
            }
        });

        document.getElementById('towns-toggle').addEventListener('change', function(e) {
            if (e.target.checked) {
                map.addLayer(townsLayer);
            } else {
                map.removeLayer(townsLayer);
            }
        });

        document.getElementById('basemap-select').addEventListener('change', function(e) {
            // Remove current base layer
            map.eachLayer(function(layer) {
                if (baseLayers['OpenStreetMap'] === layer || 
                    baseLayers['Satellite'] === layer || 
                    baseLayers['Terrain'] === layer) {
                    map.removeLayer(layer);
                }
            });
            
            // Add selected base layer
            var selectedLayer = e.target.value;
            baseLayers[selectedLayer === 'osm' ? 'OpenStreetMap' : 
                     selectedLayer === 'satellite' ? 'Satellite' : 'Terrain'].addTo(map);
        });

        // Hide info panel when clicking on map
        map.on('click', function(e) {
            hideInfoPanel();
        });
    </script>
</body>
</html>